name: Build and Release

on:
  push:
    branches:
      - master
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.1)'
        required: false
        default: ''

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Get version info
        id: version
        shell: bash
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${{ github.ref_name }}"
            IS_PRERELEASE="false"
            RELEASE_NAME="WAWA Smart ERP ${VERSION}"
          elif [[ -n "${{ github.event.inputs.version }}" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            IS_PRERELEASE="false"
            RELEASE_NAME="WAWA Smart ERP ${VERSION}"
          else
            VERSION="latest"
            IS_PRERELEASE="true"
            RELEASE_NAME="Latest Build ($(date +'%Y-%m-%d'))"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "is_prerelease=${IS_PRERELEASE}" >> $GITHUB_OUTPUT
          echo "release_name=${RELEASE_NAME}" >> $GITHUB_OUTPUT
          echo "Building version: ${VERSION}"

      - name: Update package version
        if: startsWith(github.ref, 'refs/tags/v')
        working-directory: apps/desktop
        shell: bash
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix
          npm pkg set version="$VERSION"

      - name: Build TypeScript
        working-directory: apps/desktop
        run: |
          npx tsc -p tsconfig.main.json
          npx tsc -p tsconfig.preload.json

      - name: Build Vite
        working-directory: apps/desktop
        run: npx vite build

      - name: Package Electron App
        working-directory: apps/desktop
        run: npx electron-builder --win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: List release artifacts
        run: |
          echo "=== Release Directory Contents ==="
          dir apps\desktop\release
        shell: cmd

      - name: Generate Release Notes
        id: release_notes
        shell: bash
        run: |
          echo "## What's New" > release_notes.md
          echo "" >> release_notes.md
          if [[ "${{ steps.version.outputs.is_prerelease }}" == "true" ]]; then
            echo "This is an automated build from the latest master branch." >> release_notes.md
            echo "" >> release_notes.md
            echo "### Recent Changes" >> release_notes.md
            git log --oneline -10 >> release_notes.md
          else
            echo "### Features" >> release_notes.md
            echo "- Monthly evaluation report system (월별평가 시스템)" >> release_notes.md
            echo "- Student management with Notion integration" >> release_notes.md
            echo "- Multi-teacher score input support" >> release_notes.md
            echo "- PDF report generation" >> release_notes.md
            echo "" >> release_notes.md
            echo "### Changes since last release" >> release_notes.md
            git log --oneline $(git describe --tags --abbrev=0 2>/dev/null || echo HEAD~10)..HEAD >> release_notes.md 2>/dev/null || git log --oneline -10 >> release_notes.md
          fi
          echo "" >> release_notes.md
          echo "---" >> release_notes.md
          echo "Built with Electron and React" >> release_notes.md

      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: "apps/desktop/release/*.exe,apps/desktop/release/*.exe.blockmap"
          tag: ${{ steps.version.outputs.version }}
          name: ${{ steps.version.outputs.release_name }}
          bodyFile: release_notes.md
          prerelease: ${{ steps.version.outputs.is_prerelease }}
          allowUpdates: true
          removeArtifacts: true
          replacesArtifacts: true
          token: ${{ secrets.GITHUB_TOKEN }}

  # Optional: Build for macOS (uncomment when needed)
  # build-macos:
  #   runs-on: macos-latest
  #   permissions:
  #     contents: write
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: pnpm/action-setup@v2
  #       with:
  #         version: 8
  #     - uses: actions/setup-node@v4
  #       with:
  #         node-version: 20
  #         cache: 'pnpm'
  #     - run: pnpm install
  #     - working-directory: apps/desktop
  #       run: |
  #         npx tsc -p tsconfig.main.json
  #         npx tsc -p tsconfig.preload.json
  #         npx vite build
  #         npx electron-builder --mac
  #     - uses: ncipollo/release-action@v1
  #       with:
  #         artifacts: "apps/desktop/release/*.dmg"
  #         allowUpdates: true
  #         omitBodyDuringUpdate: true
  #         token: ${{ secrets.GITHUB_TOKEN }}

name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Build TypeScript
        working-directory: apps/desktop
        run: |
          npx tsc -p tsconfig.main.json
          npx tsc -p tsconfig.preload.json

      - name: Build Vite
        working-directory: apps/desktop
        run: npx vite build

      - name: Set version from tag
        working-directory: apps/desktop
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          node -e "const fs=require('fs'); const p=JSON.parse(fs.readFileSync('package.json','utf8')); p.version='$VERSION'; fs.writeFileSync('package.json',JSON.stringify(p,null,2)+'\n');"
          echo "Set version to $VERSION"
          node -e "console.log(require('./package.json').version)"
        shell: bash

      - name: Package Electron App
        working-directory: apps/desktop
        run: npx electron-builder --win --publish never

      - name: List built files
        working-directory: apps/desktop
        run: |
          echo "=== Release directory contents ==="
          dir release
        shell: cmd

      - name: Create Release with Assets
        uses: softprops/action-gh-release@v2
        with:
          name: WAWA Smart ERP ${{ github.ref_name }}
          body: |
            ## WAWA Smart ERP ${{ github.ref_name }}

            ### 설치 방법
            1. 아래 exe 파일을 다운로드합니다
            2. 실행하여 설치를 진행합니다

            ### 변경 사항
            - 최신 버전 릴리즈
          draft: false
          prerelease: false
          files: |
            apps/desktop/release/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Artifact (Backup)
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: apps/desktop/release/*.exe
